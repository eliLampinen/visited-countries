<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SEO: description & keywords -->
  <meta name="description" content="Visited Countries — A personal travel journal to track countries visited, log trips with dates, ratings, duration and notes, and attach photos. Upload and manage photos, export/import your data, and track progress on the road to visit all countries. Country tracker, travel journal with photos, countries visited tracker and visited countries list — and much more." />
  <meta name="keywords" content="travel journal, visited countries, country tracker, travel journal with photos, countries visited tracker, visited countries list, track trips, road to visit all countries, travel photos, trip tracker, travel log" />
  <meta name="robots" content="index, follow" />
  <meta name="theme-color" content="#161129" />
  <!-- Open Graph / social preview -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Visited Countries - Your Travel Journal" />
  <meta property="og:description" content="A personal travel journal to track countries visited, log trips with notes, ratings, duration and photos. Export/import data and follow your progress on the road to visit all countries." />
  <meta property="og:image" content="image.png" />
  <meta property="og:image:alt" content="Visited Countries – travel journal with photos" />
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Visited Countries - Your Travel Journal" />
  <meta name="twitter:description" content="Track your visits, add trip notes and photos, and export your travel journal. Road to visit all countries — log every trip and photo." />
  <meta name="twitter:image" content="image.png" />
  <!-- Structured data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Visited Countries - Your Travel Journal",
    "description": "A personal travel journal to track countries visited, log trips with dates, ratings, duration and notes, and attach photos. Export/import your data and track progress toward visiting all countries.",
    "image": "image.png"
  }
  </script>
  <title>Visited Countries - Your Travel Journal</title>
  <link id="favicon" rel="icon" href="">
  <style>
    :root{
      --bg: #161129;
      --bg-2: #1b1632;
      --card: #2f275f;
      --card-2:#332e6d;
      --text:#f7f7fb;
      --muted:#d6d0f5;
      --purple:#8b5cf6;
      --purple-700:#7c3aed;
      --accent:#c4b5fd;
      --green:#9ef0c5;
      --danger:#ef6666;
      --warning:#f6a94a;
      --shadow: 0 8px 20px rgba(0,0,0,.18);
      --not-visited: #42507a;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 18% -18%, rgba(139,92,246,.22), transparent 60%),
        radial-gradient(1000px 600px at 110% 18%, rgba(196,181,253,.16), transparent 55%),
        var(--bg);
      color:var(--text);
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: saturate(120%) blur(6px);
      background: linear-gradient(180deg, rgba(22,16,41,.88), rgba(22,16,41,.72));
      border-bottom: 1px solid rgba(167,139,250,.12);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:12px 16px}
    .title{display:flex; align-items:center; gap:12px}
    .logo{
      width:38px; height:38px; border-radius:12px; background: transparent;
      display:grid; place-items:center; box-shadow: var(--shadow);
    }
    .logo span{font-weight:800; font-size:18px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .toolbar .spacer{flex:1}
    button, .btn{
      appearance:none; border:0; color:white; background:var(--purple);
      padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow: var(--shadow);
      transition: transform .05s ease, background .2s ease, opacity .2s ease;
    }
    button.ghost{background:transparent; border:1px solid rgba(167,139,250,.28); color:var(--muted)}
    button.flat{background:var(--card-2)}
    button:hover{background:var(--purple-700)}
    button:active{transform: translateY(1px)}
    .danger{background: var(--danger)}

    .app{max-width:1200px; margin:18px auto; padding:0 16px; display:grid; grid-template-columns: 1.6fr .9fr; gap:18px}
    .panel{background: linear-gradient(180deg, var(--card), var(--card-2)); border:1px solid rgba(167,139,250,.12); border-radius:16px; box-shadow: var(--shadow)}
    .panel h2{margin:0; padding:14px 16px; border-bottom:1px solid rgba(167,139,250,.09); font-size:16px; letter-spacing:.3px}
    .help-btn{
      margin-left:8px; display:inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; padding:6px; border-radius:8px; background: rgba(255,255,255,.04);
      color:var(--text); border:1px solid rgba(167,139,250,.06); cursor:pointer; box-shadow: var(--shadow); font-size:14px;
    }
    .help-btn:hover{ background: rgba(255,255,255,.06) }
    dialog.help-dialog{ padding:14px; max-width:520px; }
    dialog.help-dialog .title{ font-weight:700; margin-bottom:8px }
    .content { padding: 16px; border-top: 1px solid rgba(167,139,250,.09); border-bottom: 1px solid rgba(167,139,250,.09); }
    #map{ width:100%; height:min(70vh, 680px); touch-action: none; cursor: grab; }
    .map-wrap{ position:relative; }
    .map-legend{ position:absolute; right:10px; bottom:10px; background: rgba(21,16,42,.78); border:1px solid rgba(167,139,250,.14); border-radius:12px; padding:10px 12px; font-size:12px}
    .map-legend .swatch{ display:inline-block; width:14px; height:10px; border-radius:3px; margin-right:6px; vertical-align:middle }

    .country{ fill:var(--not-visited); stroke:#8b5cf644; stroke-width:.6; cursor:pointer; transition: fill .15s ease, stroke .2s ease }
    .country:hover{ fill:#4a3a9a }
    .country.visited{ fill:var(--green); stroke:#43b686 }

    .card{ background: linear-gradient(180deg, #352b6f, #2b2459); border:1px solid rgba(167,139,250,.12); border-radius:16px; padding:12px; margin:10px 0; box-shadow: var(--shadow)}
    .card .meta{ font-size:12px; color: var(--muted) }
    .card .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
    .badge{ background: rgba(139,92,246,.16); color:#f3edff; border:1px solid rgba(139,92,246,.22); padding:4px 8px; border-radius:999px; font-size:12px }
    .rating{ background: rgba(158,240,197,.12); color:#e9fff0; border:1px solid rgba(158,240,197,.18) }

    dialog{ background: linear-gradient(180deg, #332861, #2d2552); color:var(--text); border:1px solid rgba(167,139,250,.18); border-radius:16px; box-shadow: var(--shadow); width:min(520px, 92vw) }
    dialog::backdrop{ background: rgba(12,9,26,.54); backdrop-filter: blur(3px) }
    form .grid{ display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; align-items:start; }
    @media (max-width: 760px){ form .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 560px){ form .grid{ grid-template-columns: 1fr } }
    form .grid > div{ min-width: 0; }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px }
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      box-sizing: border-box; width:100%; background:#1e1738; color:var(--text); border:1px solid rgba(167,139,250,.12);
      border-radius:12px; padding:8px; outline:none;
    }
    textarea{ min-height:90px; resize:vertical }

    .side-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px }
    .search{ flex:1 }
    .search input{ width:100%; background:#1a1430; border:1px solid rgba(167,139,250,.10); border-radius:12px; padding:10px; color:var(--text) }

    .empty{ opacity:.9; text-align:center; padding:20px; color:var(--muted) }

    .mobile-actions{ display:none }
    @media (max-width: 960px){
      .app{ grid-template-columns: 1fr; }
      .mobile-actions{ display:flex; gap:8px; margin-top:10px }
      #sidebar{ display:none }
      #sidebar.open{ display:block }
      #map{ height: 64vh }
    }

    .side-header .search { min-width: 0; flex: 1 1 auto; }
    .side-header .search input { min-width: 0; box-sizing: border-box; }

    dialog.photo-viewer { padding:8px; max-width: 98vw; width: 98vw; border-radius:12px; background: linear-gradient(180deg, #1a1430, #130f25); }
    dialog.photo-viewer::backdrop { background: rgba(0,0,0,0.7); }
    .pv-inner { position:relative; display:flex; align-items:center; justify-content:center; width:100%; height: calc(80vh); overflow:hidden; }
    dialog.photo-viewer img { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display:block; user-select:none; -webkit-user-drag: none; }
    .pv-nav { position:absolute; top:50%; transform:translateY(-50%); width:40px; height:40px; border-radius:50%; background: rgba(0,0,0,0.35); border:0; color:white; display:grid; place-items:center; cursor:pointer; z-index:30; }
    .pv-nav:active{ transform: translateY(-50%) scale(.98) }
    .pv-prev { left:10px }
    .pv-next { right:10px }
    .pv-close { position:absolute; right:10px; top:10px; background: rgba(0,0,0,0.35); border:0; color:white; padding:6px 10px; border-radius:8px; cursor:pointer; z-index:40; }
    .pv-counter{ position:absolute; left:50%; bottom:8px; transform:translateX(-50%); color:var(--muted); font-size:13px; background: rgba(0,0,0,0.32); padding:6px 10px; border-radius:999px; z-index:30; }
    @media (max-width: 560px){
      dialog.photo-viewer { padding:6px; }
      .pv-nav { width:34px; height:34px; }
      .pv-counter{ font-size:12px; padding:5px 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
      <div class="title">
        <div class="logo" aria-hidden="true">
          <img src="image.png" alt="World icon" style="width:28px;height:28px;object-fit:contain;display:block;border-radius:8px" />
        </div>
        <div>
          <div style="font-weight:800; letter-spacing:.3px">Visited Countries - Your Travel Journal</div>
        </div>
      </div>
      <div class="toolbar" style="margin-left:auto"></div>
    </div>
  </header>

  <main class="app">
    <section id="mapPanel" class="panel">
      <h2 style="display:flex;align-items:center;gap:8px">
        <span>World Map - click a country and add your memories including photos</span>
        <button id="helpBtn" class="help-btn" aria-label="How this works" title="How this works">
          <img src="info-icon.png" alt="Info" style="width:16px;height:16px;display:block" />
        </button>
      </h2>
      <div class="content map-wrap">
        <svg id="map" role="img" aria-label="World map – click a country to add a trip"></svg>
        <div class="map-legend">
          <div><span class="swatch" style="background:#71e8b6"></span>Visited</div>
          <div><span class="swatch" style="background:var(--not-visited)"></span>Not visited</div>
        </div>
        <div class="mobile-actions">
          <button id="toggleSidebar">Show Trips</button>
        </div>
      </div>
    </section>

    <aside id="sidebar" class="panel">
      <div class="side-header">
        <h2 style="margin:0">Trips</h2>
        <div class="search"><input id="search" placeholder="Search country or notes…" /></div>
      </div>
      <div id="tripList" class="content"></div>
    </aside>
  </main>

  <!-- Trip Editor Modal -->
  <dialog id="tripModal">
    <form id="tripForm" method="dialog">
      <h3 id="modalTitle" style="margin:0 0 8px 0">Add Trip</h3>
      <div id="countryLabel" class="meta" style="margin-bottom:10px"></div>
      <input type="hidden" id="countryId">
      <input type="hidden" id="editKey"> <!-- countryId:index if editing -->
      <div class="grid">
        <div>
          <label for="tripDate">Date</label>
          <input type="date" id="tripDate" required>
        </div>
        <div>
          <label for="tripRating">Rating (1–10)</label>
          <input type="number" id="tripRating" min="1" max="10" value="7" required>
        </div>
        <div>
          <label for="tripDays">Duration (days)</label>
          <input type="number" id="tripDays" min="1" value="1" required>
        </div>
      </div>

      <div style="margin-top:10px">
        <label for="tripPhoto">Photos</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="file" id="tripPhoto" accept="image/*" multiple>
          <div style="font-size:12px;color:var(--muted)">Photos are stored locally and included with exported data (using IndexedDB under the hood).</div>
        </div>
        <div id="photoPreview" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap"></div>
      </div>

      <div style="margin-top:10px">
        <label for="tripNotes">Notes / Summary</label>
        <textarea id="tripNotes" placeholder="What made this trip memorable?"></textarea>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px">
        <button type="button" class="ghost" id="cancelModal">Cancel</button>
        <button id="saveBtn" type="submit">Add trip</button>
      </div>
    </form>
  </dialog>

  <!-- Help dialog -->
  <dialog id="helpDialog" class="help-dialog">
    <div class="title">How to use Visited Countries</div>
    <div style="font-size:13px; color:var(--muted); margin-bottom:10px">
      - Click a country on the map to add a trip (date, rating, duration, notes).<br>
      - You can add multiple visits for the same country.<br>
      - Upload photos for each trip; they’re stored locally (IndexedDB) and included when you Export.<br>
      - Use Export to download your data as JSON and Import to restore it on any device.<br>
      - Use the sidebar search to find trips by country or notes.<br>
      - Clear removes all stored trips and photos from your browser.<br>
      - Data persists in your browser until you clear it; export regularly to back up your trips.
    </div>
    <div style="display:flex; justify-content:flex-end; gap:8px;">
      <button id="closeHelp" class="ghost" type="button">Close</button>
    </div>
  </dialog>

  <!-- Photo viewer -->
  <dialog id="photoViewer" class="photo-viewer" aria-label="Photo viewer" role="dialog">
    <div class="pv-inner" id="pvInner">
      <button id="pvPrev" class="pv-nav pv-prev" aria-label="Previous photo">‹</button>
      <img id="photoViewerImg" alt="Photo preview" src="" draggable="false" />
      <button id="pvNext" class="pv-nav pv-next" aria-label="Next photo">›</button>
      <button id="closePhotoViewer" class="pv-close" aria-label="Close viewer">Close</button>
      <div id="pvCounter" class="pv-counter" aria-hidden="true"></div>
    </div>
  </dialog>

  <!-- Footer -->
  <div id="countersFooter" style="max-width:1200px;margin:18px auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px;">
    <div style="display:flex; align-items:center; gap:8px; justify-content:space-between;">
      <div style="display:flex; gap:8px; align-items:center">
        <input id="importInput" type="file" accept="application/json" hidden>
        <button id="exportBtn" title="Download your data as JSON">Export</button>
        <button id="importBtn" class="flat" title="Import a previously exported JSON">Import</button>
        <button id="clearBtn" class="ghost" title="Clear stored trips and photos">Clear all data</button>
      </div>
      <div></div>
    </div>
    <div style="display:flex; align-items:center; gap:10px;">
      <div class="badge" style="background: rgba(124,58,237,.25); color:var(--text)">Visited: <strong id="cntTotal">0</strong></div>
      <div id="cntByContinent" style="display:flex; gap:8px; flex-wrap:wrap"></div>
    </div>
  </div>

  <script type="module">
    // --- Imports (ESM via CDN) ---
    import * as d3 from 'https://cdn.jsdelivr.net/npm/d3@7/+esm';
    import { feature } from 'https://cdn.jsdelivr.net/npm/topojson-client@3/+esm';

    // =========================================================
    // Storage model (Option B)
    // - localStorage: trips metadata only (no image data)
    // - IndexedDB: photo blobs (JPEG)
    // =========================================================

    // ---------- LocalStorage ----------
    const LS_KEY = 'visitedTripsV2';
    const MAX_PHOTOS = 3;
    const CONTINENT_LABELS = { AF:'Africa', AN:'Antarctica', AS:'Asia', EU:'Europe', NA:'North America', OC:'Oceania', SA:'South America' };

    /** trips shape:
     * {
     *   [countryId]: {
     *     visits: Array<{ date:string, rating:number, days:number, notes:string, photoIds:number[] }>
     *   }
     * }
     */
    let trips = loadTrips();

    function loadTrips(){
      try{
        const raw = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
        // Ensure correct shape (no backwards compatibility, just normalize)
        for(const [k, v] of Object.entries(raw)){
          if(!v || !Array.isArray(v.visits)) raw[k] = { visits: [] };
          else {
            v.visits.forEach(t => {
              if(!Array.isArray(t.photoIds)) t.photoIds = [];
            });
          }
        }
        return raw;
      }catch { return {}; }
    }
    function saveTrips(){ localStorage.setItem(LS_KEY, JSON.stringify(trips)); }

    // ---------- IndexedDB helpers ----------
    const DB_NAME = 'visitedCountriesPhotosDB';
    const DB_VERSION = 1;
    const STORE = 'photos'; // { id:auto, tripKey:string, createdAt:number, blob:Blob }

    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = ()=> {
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            const os = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
            os.createIndex('tripKey', 'tripKey', { unique: false });
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error || new Error('IndexedDB open failed'));
      });
    }

    async function idbAddPhoto(tripKey, blob){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readwrite');
        tx.onabort = ()=> reject(tx.error);
        tx.onerror = ()=> reject(tx.error);
        const store = tx.objectStore(STORE);
        const req = store.add({ tripKey, createdAt: Date.now(), blob });
        req.onsuccess = ()=> resolve(req.result); // id
      });
    }

    async function idbGetPhotosByIds(ids = []){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readonly');
        tx.onabort = ()=> reject(tx.error);
        tx.onerror = ()=> reject(tx.error);
        const store = tx.objectStore(STORE);
        const results = [];
        let remaining = ids.length;
        if(!remaining) return resolve([]);
        ids.forEach((id, i)=>{
          const r = store.get(id);
          r.onsuccess = ()=> {
            results[i] = r.result || null;
            remaining--;
            if(remaining===0) resolve(results);
          };
          r.onerror = ()=> { remaining--; if(remaining===0) resolve(results); };
        });
      });
    }

    async function idbGetPhotosByTripKey(tripKey){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readonly');
        tx.onabort = ()=> reject(tx.error);
        tx.onerror = ()=> reject(tx.error);
        const idx = tx.objectStore(STORE).index('tripKey');
        const req = idx.getAll(IDBKeyRange.only(tripKey));
        req.onsuccess = ()=> resolve(req.result || []);
        req.onerror = ()=> resolve([]);
      });
    }

    async function idbDeletePhoto(id){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readwrite');
        tx.onabort = ()=> reject(tx.error);
        tx.onerror = ()=> reject(tx.error);
        const store = tx.objectStore(STORE);
        const r = store.delete(id);
        r.onsuccess = ()=> resolve(true);
        r.onerror = ()=> resolve(false);
      });
    }

    async function idbClearAll(){
      const db = await openDB();
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(STORE, 'readwrite');
        tx.onabort = ()=> reject(tx.error);
        tx.onerror = ()=> reject(tx.error);
        const store = tx.objectStore(STORE);
        const r = store.clear();
        r.onsuccess = ()=> resolve(true);
        r.onerror = ()=> resolve(false);
      });
    }

    // ---------- Image utilities ----------
    function canvasToBlob(canvas, type='image/jpeg', quality=0.72){
      return new Promise((resolve, reject)=>{
        canvas.toBlob(b=>{
          if(!b) reject(new Error('Failed to encode image'));
          else resolve(b);
        }, type, quality);
      });
    }

    function compressImageFile(file, maxDim = 1400, quality = 0.72){
      return new Promise((resolve, reject)=>{
        if(!(file instanceof Blob)) return reject(new Error('Not a file'));
        const img = new Image();
        img.onload = async ()=>{
          try{
            const iw = img.naturalWidth || img.width;
            const ih = img.naturalHeight || img.height;
            const max = Math.max(iw, ih);
            const ratio = max > 0 ? Math.min(1, maxDim / max) : 1;
            const cw = Math.max(1, Math.round(iw * ratio));
            const ch = Math.max(1, Math.round(ih * ratio));
            const canvas = document.createElement('canvas');
            canvas.width = cw; canvas.height = ch;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, cw, ch);
            const blob = await canvasToBlob(canvas, 'image/jpeg', quality);
            URL.revokeObjectURL(img.src);
            resolve(blob);
          }catch(err){
            URL.revokeObjectURL(img.src);
            reject(err);
          }
        };
        img.onerror = ()=> {
          URL.revokeObjectURL(img.src);
          reject(new Error('Failed to load image'));
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function readFilesAsBlobs(files){
      const arr = Array.from(files || []);
      return Promise.all(arr.map(f=>{
        if(!f || !f.type || !f.type.startsWith('image/')) return Promise.resolve(f);
        return compressImageFile(f, 1400, 0.72);
      }));
    }

    function blobToDataURL(blob){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onerror = ()=> reject(new Error('Failed to read blob'));
        r.onload = ()=> resolve(String(r.result));
        r.readAsDataURL(blob);
      });
    }

    function dataURLToBlob(dataURL){
      const [meta, data] = dataURL.split(',');
      const isBase64 = /;base64$/.test(meta) || /;base64;/.test(meta);
      const mime = (meta.split(':')[1] || 'application/octet-stream').replace(/;base64/,'');
      if(isBase64){
        const bin = atob(data);
        const len = bin.length;
        const u8 = new Uint8Array(len);
        for(let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
        return new Blob([u8], { type: mime || 'image/jpeg' });
      }else{
        return new Blob([decodeURIComponent(data)], { type: mime || 'image/jpeg' });
      }
    }

    // =========================================================
    // UI & App state
    // =========================================================
    const nameToContinent = new Map(); // (optional fallback)
    const continentById = new Map();
    let totalCountries = 0;
    let continentTotals = {};

    const svg = d3.select('#map'); const g = svg.append('g');
    const ZOOM_MAX = 32;
    const zoom = d3.zoom().scaleExtent([1, ZOOM_MAX]).on('zoom', (event)=> g.attr('transform', event.transform));
    svg.call(zoom);
    svg.on('mousedown touchstart', () => svg.style('cursor', 'grabbing'));
    svg.on('mouseup touchend touchcancel', () => svg.style('cursor', 'grab'));

    const helpBtn = document.getElementById('helpBtn');
    const helpDialog = document.getElementById('helpDialog');
    const closeHelp = document.getElementById('closeHelp');
    helpBtn?.addEventListener('click', ()=> helpDialog?.showModal());
    closeHelp?.addEventListener('click', ()=> helpDialog?.close());
    helpDialog?.addEventListener('cancel', (e)=> e.preventDefault());

    const tripListEl = document.getElementById('tripList');
    const modal = document.getElementById('tripModal');
    const form = document.getElementById('tripForm');
    const modalTitle = document.getElementById('modalTitle');
    const countryLabel = document.getElementById('countryLabel');
    const countryIdInput = document.getElementById('countryId');
    const editKeyInput = document.getElementById('editKey');
    const saveBtn = document.getElementById('saveBtn');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');

    const tripPhotoInput = document.getElementById('tripPhoto');
    const photoPreviewEl = document.getElementById('photoPreview');

    // Modal photo staging (per-trip)
    let stagedNewPhotos = [];           // Array<Blob> (newly added this edit)
    let existingPhotoIds = [];          // Array<number> (for edit mode)
    let removedExistingIds = new Set(); // Set<number>
    let currentPreviewEntries = [];     // [{type:'existing'|'new', id?, blob?, url}]

    // Viewer
    let viewerPhotos = [];
    let viewerIndex = 0;
    const viewerDialog = document.getElementById('photoViewer');
    const viewerImg = document.getElementById('photoViewerImg');
    const pvPrev = document.getElementById('pvPrev');
    const pvNext = document.getElementById('pvNext');
    const pvClose = document.getElementById('closePhotoViewer');
    const pvCounter = document.getElementById('pvCounter');
    const pvInner = document.getElementById('pvInner');

    function updateViewer(){
      if(!viewerDialog) return;
      if(!viewerPhotos || viewerPhotos.length===0){
        viewerImg.src = ''; pvCounter.textContent = '';
        pvPrev.style.display = 'none'; pvNext.style.display = 'none';
        return;
      }
      if(viewerIndex < 0) viewerIndex = 0;
      if(viewerIndex >= viewerPhotos.length) viewerIndex = viewerPhotos.length - 1;
      viewerImg.src = viewerPhotos[viewerIndex] || '';
      pvCounter.textContent = `${viewerIndex + 1} / ${viewerPhotos.length}`;
      pvPrev.style.display = (viewerPhotos.length > 1 && viewerIndex > 0) ? 'grid' : (viewerPhotos.length>1 ? 'grid' : 'none');
      pvNext.style.display = (viewerPhotos.length > 1 && viewerIndex < viewerPhotos.length - 1) ? 'grid' : (viewerPhotos.length>1 ? 'grid' : 'none');
    }
    function showPhotoViewer(urls = [], startIndex = 0){
      const arr = Array.isArray(urls) ? urls.slice() : [String(urls||'')];
      viewerPhotos = arr; viewerIndex = Math.max(0, Math.min(startIndex||0, arr.length-1));
      updateViewer(); viewerDialog.showModal(); window.addEventListener('keydown', viewerKeyHandler);
    }
    function closePhotoViewer(){ viewerDialog.close(); window.removeEventListener('keydown', viewerKeyHandler); viewerImg.src=''; viewerPhotos=[]; viewerIndex=0; }
    function viewerKeyHandler(e){
      if(!viewerDialog || !viewerDialog.open) return;
      if(e.key==='ArrowLeft'){ e.preventDefault(); if(viewerIndex>0){ viewerIndex--; updateViewer(); } }
      else if(e.key==='ArrowRight'){ e.preventDefault(); if(viewerIndex<viewerPhotos.length-1){ viewerIndex++; updateViewer(); } }
      else if(e.key==='Escape'){ e.preventDefault(); closePhotoViewer(); }
    }
    pvPrev.addEventListener('click', ()=> { if(viewerIndex>0){ viewerIndex--; updateViewer(); } });
    pvNext.addEventListener('click', ()=> { if(viewerIndex<viewerPhotos.length-1){ viewerIndex++; updateViewer(); } });
    pvClose.addEventListener('click', closePhotoViewer);
    viewerDialog.addEventListener('click', (ev)=> { if(ev.target === viewerDialog) closePhotoViewer(); });

    (function wireSwipe(){
      let startX = null, deltaX = 0;
      pvInner.addEventListener('touchstart', (ev)=> { startX = ev.touches?.[0]?.clientX ?? null; deltaX = 0; });
      pvInner.addEventListener('touchmove', (ev)=> {
        if(startX === null) return;
        const x = ev.touches?.[0]?.clientX ?? null; if(x === null) return; deltaX = x - startX;
      });
      pvInner.addEventListener('touchend', ()=> {
        if(startX === null) return;
        const threshold = 40;
        if(deltaX > threshold){ if(viewerIndex > 0) { viewerIndex -= 1; updateViewer(); } }
        else if(deltaX < -threshold){ if(viewerIndex < viewerPhotos.length - 1){ viewerIndex += 1; updateViewer(); } }
        startX = null; deltaX = 0;
      });
    })();

    // Toolbar
    document.getElementById('exportBtn').addEventListener('click', exportAll);
    document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importInput').click());
    document.getElementById('importInput').addEventListener('change', importAll);
    document.getElementById('clearBtn').addEventListener('click', async ()=>{
      if(confirm('Clear all saved trips and photos? This action cannot be undone.')){
        trips = {}; saveTrips(); await idbClearAll(); renderAll();
      }
    });

    toggleSidebarBtn?.addEventListener('click', ()=>{
      sidebar.classList.toggle('open');
      toggleSidebarBtn.textContent = sidebar.classList.contains('open') ? 'Hide Trips' : 'Show Trips';
    });

    // Map rendering
    const projection = d3.geoMercator();
    const path = d3.geoPath(projection);
    let countryNameById = new Map();
    let countriesFeat = null;

    function getCountryName(id){
      const s = String(id);
      if(countryNameById.has(s)) return countryNameById.get(s);
      const n = Number(id);
      if(!Number.isNaN(n) && countryNameById.has(n)) return countryNameById.get(n);
      if(countriesFeat){
        const f = countriesFeat.features.find(ff => String(ff.id) === s || Number(ff.id) === n);
        if(f?.properties?.name) return f.properties.name;
      }
      return `Country ${s}`;
    }

    async function loadMap(){
      const world = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json').then(r=>r.json());
      const names = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/country-names.csv').then(r=>r.text());
      d3.csvParse(names).forEach(row=>{
        countryNameById.set(String(row.id), row.name);
        const num = Number(row.id);
        if(!Number.isNaN(num)) countryNameById.set(num, row.name);
      });
      countriesFeat = feature(world, world.objects.countries);
      countriesFeat.features.forEach(f=>{
        f.properties = f.properties || {};
        f.properties.name = countryNameById.get(String(f.id)) || countryNameById.get(Number(f.id)) || f.properties.name || `Country ${f.id}`;
      });
      countriesFeat.features.forEach(f=>{
        try{
          const c = d3.geoCentroid(f);
          const code = getContinentFromCoords(c[0], c[1]);
          continentById.set(String(f.id), code);
        }catch{}
      });
      totalCountries = countriesFeat.features.length;
      continentTotals = {};
      countriesFeat.features.forEach(f=>{
        const id = String(f.id);
        const code = continentById.get(id) || (nameToContinent.get(normalizeName(f.properties?.name || '')) || 'Unknown');
        continentTotals[code] = (continentTotals[code] || 0) + 1;
      });
      draw();
      window.addEventListener('resize', draw);
      renderAll();
    }

    function getContinentFromCoords(lon, lat){
      if(lat <= -60) return 'AN';
      if(lon >= 110 && lon <= 180 && lat <= 10 && lat >= -50) return 'OC';
      if(lon > 40 && lon <= 180 && lat >= -11 && lat <= 81) return 'AS';
      if(lon >= -31 && lon <= 40 && lat >= 34 && lat <= 72) return 'EU';
      if(lon >= -20 && lon <= 55 && lat >= -35 && lat <= 38) return 'AF';
      if(lon >= -170 && lon <= -30 && lat >= 5 && lat <= 83) return 'NA';
      if(lon >= -82 && lon <= -34 && lat >= -56 && lat <= 13) return 'SA';
      return 'Unknown';
    }

    function draw(){
      if(!countriesFeat) return;
      const wrap = document.querySelector('#mapPanel .content');
      const w = wrap.clientWidth - 4;
      const h = Math.min(680, Math.max(360, Math.round(w * 0.52)));
      svg.attr('viewBox', `0 0 ${w} ${h}`).attr('width', w).attr('height', h);
      projection.fitExtent([[10,10],[w-10, h-10]], countriesFeat);
      try {
        const [[minX, minY], [maxX, maxY]] = path.bounds(countriesFeat);
        const pad = Math.max(40, Math.round(Math.min(w,h) * 0.06));
        zoom.translateExtent([[minX - pad, minY - pad], [maxX + pad, maxY + pad]]);
      } catch {
        zoom.translateExtent([[ -w * 0.25, -h * 0.25 ], [ w * 1.25, h * 1.25 ]]);
      }

      const paths = g.selectAll('path.country').data(countriesFeat.features, d=>d.id);
      const entered = paths.enter().append('path')
        .attr('class', d=> 'country'+(hasTrips(d.id)?' visited':'')) .attr('d', path)
        .on('click', (_, d)=> openModalForCountry(d.id));
      entered.append('title').text(d => getCountryName(d.id));
      paths.attr('class', d=> 'country'+(hasTrips(d.id)?' visited':'')) .attr('d', path)
        .select('title').text(d => getCountryName(d.id));
      paths.exit().remove();
    }

    function hasTrips(countryId){
      const entry = trips[String(countryId)];
      return !!(entry && Array.isArray(entry.visits) && entry.visits.length > 0);
    }

    // ---------- Modal open / edit ----------
    async function openModalForCountry(id, editIndex = null){
      const name = getCountryName(id);
      const entry = trips[String(id)] || { visits: [] };
      const count = (entry.visits || []).length;
      countryIdInput.value = String(id);

      stagedNewPhotos = [];
      removedExistingIds = new Set();

      if(editIndex !== null){
        editKeyInput.value = `${id}:${editIndex}`;
        const t = (entry.visits || [])[editIndex] || {};
        document.getElementById('tripDate').value = t.date || '';
        document.getElementById('tripRating').value = t.rating ?? 7;
        document.getElementById('tripDays').value = t.days ?? 1;
        document.getElementById('tripNotes').value = t.notes || '';
        existingPhotoIds = Array.isArray(t.photoIds) ? t.photoIds.slice() : [];
        modalTitle.textContent = `Edit trip — ${name}`;
        countryLabel.textContent = `Country: ${name} — Editing trip ${Number(editIndex)+1} of ${count}`;
        saveBtn.textContent = 'Save changes';
      } else {
        editKeyInput.value = '';
        document.getElementById('tripDate').value = '';
        document.getElementById('tripRating').value = 7;
        document.getElementById('tripDays').value = 1;
        document.getElementById('tripNotes').value = '';
        existingPhotoIds = [];
        modalTitle.textContent = `Add trip — ${name}`;
        countryLabel.textContent = `Country: ${name} — Adding new trip (${count} existing)`;
        saveBtn.textContent = 'Add trip';
      }

      await renderPhotoPreview(String(id), editIndex);
      modal.showModal();
    }

    document.getElementById('cancelModal').addEventListener('click', ()=>{
      resetModalFields();
      modal.close();
    });

    function resetModalFields(){
      editKeyInput.value = '';
      document.getElementById('tripDate').value = '';
      document.getElementById('tripRating').value = 7;
      document.getElementById('tripDays').value = 1;
      document.getElementById('tripNotes').value = '';
      stagedNewPhotos = [];
      existingPhotoIds = [];
      removedExistingIds = new Set();
      currentPreviewEntries = [];
      photoPreviewEl.innerHTML = '';
    }

    // ---------- Photo preview in modal ----------
    async function renderPhotoPreview(countryId, editIndex){
      photoPreviewEl.innerHTML = '';
      currentPreviewEntries = [];

      // Load existing photos (for edit mode) except those marked removed
      const existingIdsEffective = existingPhotoIds.filter(id => !removedExistingIds.has(id));
      const existingRecords = await idbGetPhotosByIds(existingIdsEffective);
      const existingUrls = existingRecords.map(rec => rec?.blob ? URL.createObjectURL(rec.blob) : null);

      existingIdsEffective.forEach((id, idx)=>{
        const url = existingUrls[idx];
        if(!url) return;
        currentPreviewEntries.push({ type:'existing', id, url });
      });

      // Add staged new photos
      for(const blob of stagedNewPhotos){
        const url = URL.createObjectURL(blob);
        currentPreviewEntries.push({ type:'new', blob, url });
      }

      if(currentPreviewEntries.length===0){
        photoPreviewEl.innerHTML = `<div style="color:var(--muted); font-size:12px">No photos for this trip yet.</div>`;
        return;
      }

      currentPreviewEntries.forEach((entry, i)=>{
        const wrap = document.createElement('div');
        wrap.style.position = 'relative';
        wrap.style.width = '120px';
        wrap.style.height = '80px';
        wrap.style.borderRadius = '8px';
        wrap.style.overflow = 'hidden';
        wrap.style.background = '#0b0720';
        wrap.style.display = 'inline-block';
        const img = document.createElement('img');
        img.src = entry.url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.display = 'block';
        img.title = 'Tap to open full image';
        img.addEventListener('click', ()=> showPhotoViewer(currentPreviewEntries.map(e=>e.url), i));

        const rem = document.createElement('button');
        rem.type = 'button';
        rem.textContent = '✕';
        rem.title = 'Remove photo';
        rem.style.position = 'absolute';
        rem.style.right = '6px';
        rem.style.top = '6px';
        rem.style.border = '0';
        rem.style.background = 'rgba(0,0,0,.5)';
        rem.style.color = 'white';
        rem.style.borderRadius = '50%';
        rem.style.width = '22px';
        rem.style.height = '22px';
        rem.style.cursor = 'pointer';
        rem.addEventListener('click', ()=>{
          if(!confirm('Remove this photo from the trip?')) return;
          const e = currentPreviewEntries[i];
          if(e.type === 'existing'){
            removedExistingIds.add(e.id);
            existingPhotoIds = existingPhotoIds.filter(pid => pid !== e.id);
          }else{
            const idx = stagedNewPhotos.indexOf(e.blob);
            if(idx>=0) stagedNewPhotos.splice(idx,1);
          }
          renderPhotoPreview(countryId, editIndex);
        });

        wrap.appendChild(img);
        wrap.appendChild(rem);
        photoPreviewEl.appendChild(wrap);
      });
    }

    // Add photos input
    tripPhotoInput?.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length) return;
      try{
        const currentCount = existingPhotoIds.filter(id=>!removedExistingIds.has(id)).length + stagedNewPhotos.length;
        const remaining = Math.max(0, MAX_PHOTOS - currentCount);
        if(remaining <= 0){
          alert(`Maximum ${MAX_PHOTOS} photos allowed per trip.`);
        }else{
          const filesToRead = files.slice(0, remaining);
          const blobs = await readFilesAsBlobs(filesToRead);
          stagedNewPhotos.push(...blobs);
          if(files.length > remaining){
            alert(`Added ${remaining} photo(s). Maximum ${MAX_PHOTOS} photos allowed per trip.`);
          }
          await renderPhotoPreview(countryIdInput.value, editKeyInput.value ? Number(editKeyInput.value.split(':')[1]) : null);
        }
      }catch(err){
        alert('Failed to add photos: ' + err.message);
      }
      e.target.value = '';
    });

    // ---------- Save trip ----------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = countryIdInput.value;
      const entry = {
        date: (document.getElementById('tripDate').value||'').trim(),
        rating: Number(document.getElementById('tripRating').value||'0'),
        days: Math.max(1, Math.floor(Number(document.getElementById('tripDays').value||'1'))),
        notes: (document.getElementById('tripNotes').value||'').trim(),
      };
      if(!entry.date || !(entry.rating>=1 && entry.rating<=10) || !(entry.days>=1)){
        alert('Please provide a date, a rating between 1 and 10, and duration of at least 1 day.');
        return;
      }

      trips[id] = trips[id] || { visits: [] };
      const key = editKeyInput.value;

      if(key){
        const [, idxStr] = key.split(':');
        const idx = Number(idxStr);
        const visit = trips[id].visits[idx] || { photoIds: [] };

        // Delete removed existing photos
        for(const pid of Array.from(removedExistingIds)) await idbDeletePhoto(pid);

        // Add new photos to IDB
        const tripKey = `${id}:${idx}`;
        for(const blob of stagedNewPhotos){
          const newId = await idbAddPhoto(tripKey, blob);
          visit.photoIds.push(newId);
        }

        // Update metadata (keep only ids that still exist)
        visit.photoIds = visit.photoIds.filter(pid => !removedExistingIds.has(pid));
        visit.date = entry.date; visit.rating = entry.rating; visit.days = entry.days; visit.notes = entry.notes;
        trips[id].visits[idx] = visit;
      } else {
        // Add mode: first push a visit with no photos to get index
        const newVisit = { date: entry.date, rating: entry.rating, days: entry.days, notes: entry.notes, photoIds: [] };
        trips[id].visits.push(newVisit);
        const idx = trips[id].visits.length - 1;
        const tripKey = `${id}:${idx}`;
        for(const blob of stagedNewPhotos){
          const newId = await idbAddPhoto(tripKey, blob);
          newVisit.photoIds.push(newId);
        }
        trips[id].visits[idx] = newVisit;
      }

      saveTrips();
      stagedNewPhotos = []; removedExistingIds = new Set(); existingPhotoIds = [];
      modal.close();
      renderAll();
    });

    // ---------- Sidebar list ----------
    document.getElementById('search').addEventListener('input', (e)=> renderTripsList(e.target.value));

    function renderTripsList(filter=''){
      const query = (filter||'').trim().toLowerCase();
      const items = [];
      for(const [id, obj] of Object.entries(trips)){
        if(!obj) continue;
        const visits = obj.visits || [];
        if(!Array.isArray(visits) || visits.length === 0) continue;
        const name = getCountryName(id);
        visits.forEach((t, idx)=> items.push({ id, idx, name, ...t }));
      }
      items.sort((a,b)=> (b.date||'').localeCompare(a.date||'') || a.name.localeCompare(b.name));
      const filtered = query ? items.filter(it=> it.name.toLowerCase().includes(query) || (it.notes||'').toLowerCase().includes(query) ) : items;

      if(filtered.length===0){
        tripListEl.innerHTML = `<div class="empty">No trips yet. Use the map to add your trips.</div>`;
        return;
      }

      // Build cards (thumbnails filled asynchronously)
      tripListEl.innerHTML = filtered.map(it=>{
        const dateStr = it.date ? new Date(it.date).toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}) : 'No date';
        const notes = it.notes ? it.notes.replace(/</g,'&lt;') : '';
        const daysLabel = it.days ? `${it.days} day${it.days===1?'':'s'}` : '—';
        return `
          <div class="card" data-key="${it.id}:${it.idx}">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:700; display:flex; align-items:center; gap:8px">
                <div class="thumbs" data-thumb="${it.id}:${it.idx}" style="display:flex;gap:6px"></div>
                <div>${it.name}</div>
              </div>
              <div class="meta">${dateStr}</div>
            </div>
            <div class="row" style="margin:6px 0">
              <span class="badge rating">Rating: ${it.rating}/10</span>
              <span class="badge">Duration: ${daysLabel}</span>
              <span class="badge">Trips to this country: ${(trips[it.id] && trips[it.id].visits) ? (trips[it.id].visits.length) : 0}</span>
            </div>
            <div class="meta" style="white-space:pre-wrap">${notes || '<em>No notes</em>'}</div>
            <div class="row" style="justify-content:flex-end; margin-top:10px">
              <button class="flat" data-action="edit">Edit</button>
              <button class="ghost" data-action="focus">Focus on map</button>
              <button class="danger" data-action="delete">Delete</button>
            </div>
          </div>`;
      }).join('');

      // Bind card actions
      tripListEl.querySelectorAll('.card').forEach(card=>{
        const [countryId, indexStr] = card.dataset.key.split(':');
        const idx = Number(indexStr);
        card.querySelector('[data-action="edit"]').addEventListener('click', ()=> openModalForCountry(countryId, idx));
        card.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteTrip(countryId, idx));
        card.querySelector('[data-action="focus"]').addEventListener('click', ()=> focusCountry(countryId));
      });

      // Fill thumbnails asynchronously
      (async ()=>{
        const containers = Array.from(document.querySelectorAll('[data-thumb]'));
        for(const cont of containers){
          const [cid, idxStr] = cont.getAttribute('data-thumb').split(':');
          const idx = Number(idxStr);
          const visit = trips[cid]?.visits?.[idx];
          if(!visit) continue;
          const ids = (visit.photoIds || []).slice(0, MAX_PHOTOS);
          if(!ids.length) continue;
          const recs = await idbGetPhotosByIds(ids);
          const urls = recs.map(r=> r?.blob ? URL.createObjectURL(r.blob) : null).filter(Boolean);
          urls.forEach((u, i)=>{
            const img = document.createElement('img');
            img.src = u;
            img.style.width = '48px'; img.style.height = '36px'; img.style.objectFit = 'cover'; img.style.borderRadius = '6px';
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', async (ev)=>{
              ev.stopPropagation();
              // Open viewer with full set for this visit
              const allRecs = await idbGetPhotosByIds(visit.photoIds || []);
              const allUrls = allRecs.map(r=> r?.blob ? URL.createObjectURL(r.blob) : null).filter(Boolean);
              showPhotoViewer(allUrls, i);
            });
            cont.appendChild(img);
          });
        }
      })();
    }

    async function deleteTrip(countryId, idx){
      const name = getCountryName(String(countryId)) || 'this country';
      if(!confirm(`Delete this trip entry for ${name}?`)) return;
      if(!trips[countryId]) return;
      const visits = trips[countryId].visits || [];
      const visit = visits[idx];
      // delete photos from IDB
      if(visit && Array.isArray(visit.photoIds)) {
        for(const pid of visit.photoIds) await idbDeletePhoto(pid);
      }
      visits.splice(idx,1);
      trips[countryId].visits = visits;
      saveTrips();
      renderAll();
    }

    function focusCountry(countryId){
      const sel = g.selectAll('path.country').filter(d=> String(d.id)===String(countryId));
      if(!sel.node()) return;
      const bounds = path.bounds(sel.datum());
      const [[x0,y0],[x1,y1]] = bounds;
      const pad = 20;
      const vb = svg.attr('viewBox').split(' ').map(Number);
      const W = vb[2], H = vb[3];
      const dx = x1 - x0, dy = y1 - y0;
      const cx = (x0 + x1)/2, cy = (y0 + y1)/2;
      const scale = Math.min(W/(dx + pad*2), H/(dy + pad*2));
      const clampedScale = Math.min(scale, ZOOM_MAX);
      const t = d3.zoomIdentity.translate(W/2, H/2).scale(clampedScale).translate(-cx, -cy);
      svg.transition().duration(600).call(zoom.transform, t);
    }

    // Counters
    function updateCounters(){
      const cntEl = document.getElementById('cntTotal');
      const byContEl = document.getElementById('cntByContinent');
      const counts = { totalVisitedCountries: 0, byContVisited: {} };
      for(const [cid, obj] of Object.entries(trips)){
        const visits = (obj && Array.isArray(obj.visits)) ? obj.visits : [];
        if(!visits.length) continue;
        counts.totalVisitedCountries += 1;
        const centroidCont = continentById.get(String(cid));
        let cont = centroidCont;
        if(!cont || cont === 'Unknown'){
          const cname = getCountryName(cid);
          const norm = normalizeName(cname);
          cont = nameToContinent.get(norm) || cont || 'Unknown';
        }
        counts.byContVisited[cont] = (counts.byContVisited[cont] || 0) + 1;
      }
      if(cntEl) cntEl.innerHTML = `${counts.totalVisitedCountries} / ${totalCountries || 0}`;
      if(byContEl){
        byContEl.innerHTML = '';
        const order = ['EU','AS','AF','NA','SA','OC','AN'];
        order.forEach(code=>{
          const visited = counts.byContVisited[code] || 0;
          const total = continentTotals[code] || 0;
          const label = CONTINENT_LABELS[code] || code;
          const el = document.createElement('div');
          el.className = 'badge';
          el.style.background = 'rgba(124,58,237,.12)';
          el.style.color = 'var(--muted)';
          el.style.padding = '6px 8px';
          el.style.borderRadius = '8px';
          el.innerHTML = `<strong style="color:var(--text);margin-right:6px">${visited}</strong>${label} ${visited}/${total}`;
          byContEl.appendChild(el);
        });
        const unknownVisited = counts.byContVisited['Unknown'] || 0;
        const unknownTotal = continentTotals['Unknown'] || 0;
        if(unknownVisited || unknownTotal){
          const el = document.createElement('div');
          el.className = 'badge';
          el.style.background = 'rgba(124,58,237,.06)';
          el.style.color = 'var(--muted)';
          el.style.padding = '6px 8px';
          el.style.borderRadius = '8px';
          el.innerHTML = `<strong style="color:var(--text);margin-right:6px">${unknownVisited}</strong>Other ${unknownVisited}/${unknownTotal}`;
          byContEl.appendChild(el);
        }
      }
    }

    function renderAll(){
      g.selectAll('path.country').attr('class', d=> 'country'+(hasTrips(d.id)?' visited':'')); // map fill
      renderTripsList(document.getElementById('search').value || '');
      updateCounters();
    }

    // Export (trips + photos as dataURLs)
    async function exportAll(){
      const out = { version: 2, trips: {} };
      for(const [cid, obj] of Object.entries(trips)){
        if(!obj || !Array.isArray(obj.visits)) continue;
        const visitsOut = [];
        for(const v of obj.visits){
          const photos = [];
          if(Array.isArray(v.photoIds) && v.photoIds.length){
            const recs = await idbGetPhotosByIds(v.photoIds);
            for(const rec of recs){
              if(rec?.blob){
                const dataUrl = await blobToDataURL(rec.blob);
                photos.push(dataUrl);
              }
            }
          }
          visitsOut.push({ date: v.date, rating: v.rating, days: v.days, notes: v.notes, photos });
        }
        out.trips[cid] = { visits: visitsOut };
      }
      const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'visited-countries-trips.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Import (rebuild trips + write photos into IndexedDB)
    async function importAll(e){
      const file = e.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(!data || typeof data !== 'object' || !data.trips) throw new Error('Invalid file format');
        // Clear current data
        trips = {};
        await idbClearAll();

        // Rebuild
        for(const [cid, obj] of Object.entries(data.trips)){
          const visitsIn = Array.isArray(obj?.visits) ? obj.visits : [];
          trips[cid] = { visits: [] };
          for(const v of visitsIn){
            const visit = { date: v.date, rating: v.rating, days: v.days, notes: v.notes, photoIds: [] };
            trips[cid].visits.push(visit);
            const idx = trips[cid].visits.length - 1;
            const tripKey = `${cid}:${idx}`;
            const photosArr = Array.isArray(v.photos) ? v.photos : [];
            for(const p of photosArr){
              const blob = dataURLToBlob(String(p));
              const id = await idbAddPhoto(tripKey, blob);
              visit.photoIds.push(id);
            }
          }
        }
        saveTrips();
        renderAll();
      }catch(err){
        alert('Import failed: ' + err.message);
      }
      e.target.value = '';
    }

    // Utilities
    function normalizeName(s){ return String(s||'').trim().toLowerCase(); }

    // Boot
    loadMap();

    // Favicon
    (function setFavicon(){
      const link = document.getElementById('favicon');
      if(link){ link.href = 'image.png'; }
    })();
  </script>
</body>
</html>
